rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is staff member
    function isStaff() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/staffUsers/$(request.auth.uid));
    }
    
    // Helper function to get staff user data
    function getStaffUser() {
      return get(/databases/$(database)/documents/staffUsers/$(request.auth.uid)).data;
    }
    
    // Helper function to check if user has specific role
    function hasRole(role) {
      return isStaff() && getStaffUser().role == role && getStaffUser().isActive == true;
    }
    
    // Helper function to check if user is admin (manager or superadmin)
    function isAdmin() {
      return hasRole('superadmin') || hasRole('manager');
    }
    
    // Helper function to validate pickup request data
    function isValidPickupRequest() {
      let data = request.resource.data;
      return data.keys().hasAll(['productName', 'price', 'customer', 'pickupDate', 'createdAt'])
             && data.productName is string
             && data.productName.size() > 0
             && data.productName.size() <= 200
             && data.price is number
             && data.price >= 0
             && data.price <= 10000000
             && data.customer is map
             && data.customer.name is string
             && data.customer.name.size() > 0
             && data.customer.name.size() <= 100;
    }
    
    // Helper function to validate valuation data
    function isValidValuation() {
      let data = request.resource.data;
      return data.keys().hasAll(['productId', 'price', 'createdAt'])
             && data.price is number
             && data.price >= 0
             && data.price <= 10000000;
    }
    
    // Staff Users Collection - Only Super Admins can manage
    match /staffUsers/{userId} {
      allow read: if isStaff();
      allow create, update, delete: if hasRole('superadmin');
    }
    
    // Products Collection
    match /products/{productId} {
      // Anyone can read products (for public website)
      allow read: if true;
      
      // Only managers and superadmins can add/edit products
      allow create, update: if isAdmin();
      
      // Only superadmins can delete products
      allow delete: if hasRole('superadmin');
    }
    
    // Product Pricing Collection
    match /productPricing/{productId} {
      // Anyone can read pricing (needed for valuation flow)
      allow read: if true;
      
      // Only managers and superadmins can manage pricing
      allow create, update: if isAdmin();
      
      // Only superadmins can delete pricing
      allow delete: if hasRole('superadmin');
    }
    
    // Counters Collection - Server-side only via Admin SDK
    // Client-side access is restricted; order ID generation happens server-side
    match /counters/{counterId} {
      // Only staff can read counters (for monitoring)
      allow read: if isStaff();
      
      // Only admin can manually modify (for corrections)
      // Note: Server-side Admin SDK bypasses these rules
      allow write: if isAdmin();
    }
    
    // Pickup Requests Collection
    match /pickupRequests/{requestId} {
      // Authenticated users can create pickup requests with validation
      // Note: Unauthenticated creates go through Cloud Functions with Admin SDK
      allow create: if isAuthenticated() && isValidPickupRequest();
      
      // Users can read their own requests
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Staff can read all
      allow read: if isStaff();
      
      // Authenticated users can update their own pickup requests (for cancel/reschedule)
      // Only allow specific fields to be updated
      allow update: if isAuthenticated() 
                       && resource.data.userId == request.auth.uid
                       && request.resource.data.diff(resource.data).affectedKeys()
                          .hasOnly(['status', 'pickupDate', 'pickupTime', 'updatedAt']);
      
      // Staff can update any pickup requests (status changes, etc.)
      allow update: if isStaff();
      
      // Only superadmins can delete pickup requests
      allow delete: if hasRole('superadmin');
    }
    
    // Valuations Collection
    match /valuations/{valuationId} {
      // Authenticated users can create valuations with validation
      // Note: Unauthenticated creates go through Cloud Functions with Admin SDK
      allow create: if isAuthenticated() && isValidValuation();
      
      // Users can read their own valuations
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Staff can read all
      allow read: if isStaff();
      
      // Authenticated users can update their own valuations (limited fields)
      allow update: if isAuthenticated() 
                       && resource.data.userId == request.auth.uid
                       && request.resource.data.diff(resource.data).affectedKeys()
                          .hasOnly(['status', 'updatedAt']);
      
      // Staff can update any valuations
      allow update: if isStaff();
      
      // Only superadmins can delete valuations
      allow delete: if hasRole('superadmin');
    }
    
    // Settings Collection
    match /settings/{document=**} {
      // Anyone can read settings (for pricing rules, etc.)
      allow read: if true;
      
      // Only admins can write settings
      allow write: if isAdmin();
    }
    
    // Users Collection (for customer data and coins)
    match /users/{userId} {
      // Users can read their own data, staff can read all users
      allow read: if isAuthenticated() && 
                     (request.auth.uid == userId || isStaff());
      
      // Users can create and update their own data
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && 
                       (request.auth.uid == userId || isStaff());
      
      // Only superadmins can delete users
      allow delete: if hasRole('superadmin');
    }
    
    // Email Logs Collection - Staff only
    match /emailLogs/{logId} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }
    
    // Mail Collection (if you have this)
    match /mail/{document=**} {
      allow read, write: if isStaff();
    }
    
    // Devices Collection - Read only for public, write for admin
    match /devices/{deviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
